<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UPSC Daily Test | Free &amp; Paid Mock Tests</title>
  <meta name="description" content="Free persistent mock tests + affordable paid daily series for UPSC Prelims &amp; Mains. Real exam pattern questions, instant scoring, and live ranking.">
  <meta name="keywords" content="UPSC, UPSC test, UPSC daily test, UPSC mock test free, UPSC paid test series, free UPSC practice">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://cronbpsc.vercel.app/">
  <meta property="og:title" content="UPSC Daily Test – Free &amp; Paid Series">
  <meta property="og:description" content="Persistent free mocks + daily paid test series with ranking. Real UPSC pattern questions.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://cronbpsc.vercel.app/">
  <meta property="og:image" content="https://cronbpsc.vercel.app/og-bpsc.jpg">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    window.firebaseModules = {
      initializeApp, getAnalytics, getAuth, signInWithPopup, GoogleAuthProvider,
      onAuthStateChanged, signOut
    };
  </script>

  <style>
    :root {
      --primary: #0f172a;
      --secondary: #1e293b;
      --accent: #f59e0b;
      --success: #10b981;
      --danger: #ef4444;
      --text: #f8fafc;
      --text-secondary: #cbd5e1;
      --border: #334155;
      --bg-overlay: rgba(15, 23, 42, 0.92);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--text);
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(248,250,252,0.03) 2px, rgba(248,250,252,0.03) 4px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(248,250,252,0.03) 2px, rgba(248,250,252,0.03) 4px);
      pointer-events: none;
      z-index: 1;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem;
      position: relative;
      z-index: 2;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 0;
      border-bottom: 2px solid var(--border);
      margin-bottom: 2rem;
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.8rem;
      color: var(--accent);
      letter-spacing: -1px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    .btn {
      padding: 0.8rem 1.8rem;
      border: none;
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover { opacity: 0.88; transform: translateY(-1px); }
    .btn-free   { background: var(--success); color: white; font-size: 1.05rem; }
    .btn-paid   { background: var(--accent);  color: var(--primary); font-size: 1.05rem; }
    .btn-review { background: #8b5cf6; color: white; }
    .btn-google { background: #4285f4; color: white; }
    .btn-logout { background: var(--danger); color: white; font-size: 0.85rem; padding: 0.5rem 1.1rem; }
    .btn-back   { background: var(--secondary); color: var(--text-secondary); border: 1px solid var(--border); font-size: 0.9rem; padding: 0.5rem 1.1rem; }

    .hidden { display: none !important; }

    /* ── Cards ── */
    .card {
      background: var(--bg-overlay);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 1.8rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(8px);
    }

    /* ── Home mode-selection ── */
    .mode-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .mode-card {
      background: var(--bg-overlay);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 2rem;
      backdrop-filter: blur(8px);
      transition: border-color 0.2s, transform 0.2s;
    }

    .mode-card:hover { border-color: var(--accent); transform: translateY(-3px); }
    .mode-card h2 { font-family: 'Playfair Display', serif; font-size: 1.6rem; margin-bottom: 0.8rem; color: var(--accent); }
    .mode-card p  { color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.7; }
    .price { color: var(--accent); font-weight: 700; }

    /* ── Section headings ── */
    .section-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.8rem;
    }

    .section-header h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      color: var(--accent);
      flex: 1;
    }

    /* ── Test list grid ── */
    .tests-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .test-card {
      background: var(--bg-overlay);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      backdrop-filter: blur(8px);
      transition: border-color 0.2s, transform 0.2s;
      cursor: pointer;
    }

    .test-card:hover { border-color: var(--accent); transform: translateY(-3px); }
    .test-card h3 { color: var(--accent); font-size: 1.1rem; margin-bottom: 1rem; line-height: 1.4; }

    .test-card-meta {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-bottom: 1.2rem;
      font-size: 0.88rem;
      color: var(--text-secondary);
    }

    .test-card-meta span strong { color: var(--text); }

    .test-card .btn { width: 100%; text-align: center; }

    /* ── Status messages ── */
    .status-message {
      font-size: 1.1rem;
      font-weight: 600;
      padding: 1.2rem 1.5rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      text-align: center;
    }

    .status-not-started { background: rgba(245,158,11,0.15); border: 1px solid var(--accent); color: var(--accent); }
    .status-archived    { background: rgba(139,92,246,0.15); border: 1px solid #8b5cf6;        color: #c4b5fd; }
    .status-no-test     { background: rgba(239,68,68,0.15);  border: 1px solid var(--danger);  color: var(--danger); }

    /* ── Questions ── */
    .question {
      margin: 1.5rem 0;
      padding: 1.5rem;
      background: rgba(30,41,59,0.6);
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .question h3 { margin-bottom: 1.2rem; color: var(--accent); font-size: 1.05rem; line-height: 1.5; }

    .option {
      display: block;
      margin: 0.7rem 0;
      padding: 0.9rem 1rem;
      background: var(--secondary);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      font-size: 0.95rem;
    }

    .option:hover   { border-color: var(--accent); }
    .option.selected { background: rgba(245,158,11,0.15); border-color: var(--accent); }

    /* ── Alerts ── */
    .alert {
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
      font-weight: 600;
      text-align: center;
    }

    .alert-success { background: rgba(16,185,129,0.2);  color: var(--success); border: 1px solid var(--success); }
    .alert-warning { background: rgba(245,158,11,0.2);  color: var(--accent);  border: 1px solid var(--accent); }
    .alert-error   { background: rgba(239,68,68,0.2);   color: var(--danger);  border: 1px solid var(--danger); }
    .alert-info    { background: rgba(139,92,246,0.15); color: #c4b5fd;        border: 1px solid #8b5cf6; }

    /* ── Leaderboard ── */
    #leaderboard table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    #leaderboard th, #leaderboard td { padding: 0.8rem; text-align: left; border-bottom: 1px solid var(--border); }
    #leaderboard th { color: var(--accent); }

    /* ── Result ── */
    .rank-display {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      text-align: center;
      margin: 1.2rem 0;
    }

    .correct { color: var(--success); font-weight: bold; }
    .wrong   { color: var(--danger);  font-weight: bold; }

    .persistent-note {
      font-size: 0.9rem;
      color: var(--success);
      margin-top: 0.4rem;
      font-weight: 500;
    }

    /* ── Loading spinner ── */
    .loader {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .loader::after {
      content: '';
      display: inline-block;
      width: 1.2rem;
      height: 1.2rem;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 0.6rem;
      vertical-align: middle;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Login card ── */
    #loginSection { text-align: center; }
    #loginSection h2 { font-family: 'Playfair Display', serif; font-size: 1.8rem; color: var(--accent); margin-bottom: 0.8rem; }
    #loginSection p  { color: var(--text-secondary); margin-bottom: 2rem; line-height: 1.7; }

    .login-btn-wrap { display: flex; justify-content: center; }

    /* ── Responsive ── */
    @media (max-width: 768px) {
      .mode-cards, .tests-grid { grid-template-columns: 1fr; }
      h1 { font-size: 2rem; }
      .container { padding: 1rem; }
    }
  </style>
</head>

<body>
<noscript>
  <div style="padding: 3rem 1rem; text-align:center; background:#0f172a; color:#f8fafc; min-height:100vh;">
    <h1 style="font-family: 'Playfair Display', serif; color:#f59e0b;">UPSC Daily Test</h1>
    <p>JavaScript is required to use this platform.</p>
  </div>
</noscript>

<div class="container">

  <!-- ── Header ── -->
  <header>
    <h1>UPSC Daily Test</h1>
    <div class="user-info">
      <span id="userDisplay">Guest</span>
      <button id="btnLogout" class="btn btn-logout hidden">Logout</button>
    </div>
  </header>

  <!-- ══════════════════════════════════════════
       SECTION 1 — Home (mode selection)
  ══════════════════════════════════════════ -->
  <div id="sectionHome">
    <div class="mode-cards">
      <div class="mode-card">
        <h2>Free Test Series</h2>
        <p>Multiple persistent practice sets · Real UPSC pattern · Instant score + leaderboard per test</p>
        <button id="btnBrowseFree" class="btn btn-free">Browse Free Tests</button>
      </div>
      <div class="mode-card">
        <h2>Paid Daily Series</h2>
        <p>Fresh daily test · Personalised ranking · 24-hour window<br>
          <span class="price">₹9 / month</span> &nbsp;or&nbsp; <span class="price">₹100 / year</span>
        </p>
        <button id="btnBrowsePaid" class="btn btn-paid">Browse Paid Tests</button>
      </div>
    </div>
  </div>

  <!-- ══════════════════════════════════════════
       SECTION 2 — Free Tests List
  ══════════════════════════════════════════ -->
  <div id="sectionFreeList" class="hidden">
    <div class="section-header">
      <button id="btnBackFromFreeList" class="btn btn-back">← Back</button>
      <h2>Free Practice Tests</h2>
    </div>
    <div id="freeTestsGrid" class="tests-grid"></div>
  </div>

  <!-- ══════════════════════════════════════════
       SECTION 3 — Paid Login Gate
  ══════════════════════════════════════════ -->
  <div id="sectionPaidLogin" class="card hidden">
    <h2>Sign in to Access Paid Tests</h2>
    <p>Unlock daily tests, personalised ranking &amp; detailed review</p>
    <div class="login-btn-wrap">
      <button id="btnGoogleLogin" class="btn btn-google">Sign in with Google</button>
    </div>
    <div id="authMessage" style="margin-top:1.2rem; min-height:1.5rem; text-align:center;"></div>
    <div style="text-align:center; margin-top:1.5rem;">
      <button id="btnBackFromLogin" class="btn btn-back">← Back</button>
    </div>
  </div>

  <!-- ══════════════════════════════════════════
       SECTION 4 — Paid Tests List
       (shown after login)
  ══════════════════════════════════════════ -->
  <div id="sectionPaidList" class="hidden">
    <div class="section-header">
      <button id="btnBackFromPaidList" class="btn btn-back">← Back</button>
      <h2>Paid Daily Tests</h2>
    </div>
    <div id="paidTestsGrid" class="tests-grid"></div>
  </div>

  <!-- ══════════════════════════════════════════
       SECTION 5 — Active Test (questions)
  ══════════════════════════════════════════ -->
  <div id="sectionTest" class="hidden">
    <div class="card">
      <div class="section-header" style="margin-bottom:0.5rem;">
        <button id="btnBackFromTest" class="btn btn-back">← Back</button>
        <h2 id="testTitle">Loading…</h2>
      </div>

      <p id="testInfo" style="color:var(--text-secondary); text-align:center; margin:0.8rem 0;"></p>
      <p id="persistentNote" class="persistent-note hidden" style="text-align:center;"></p>

      <div id="statusMessage" class="status-message hidden"></div>

      <div id="lateWarning" class="alert alert-warning hidden">
        You are submitting after the window closed. This will be recorded as a practice attempt and will not appear in the ranked leaderboard.
      </div>

      <div id="questionsContainer"></div>

      <button id="btnSubmitTest" class="btn btn-paid hidden"
              style="margin: 2rem auto; display: block; width: 220px;">
        Submit Test
      </button>

      <button id="btnReviewTest" class="btn btn-review hidden"
              style="margin: 2rem auto; display: block; width: 220px;">
        Review Your Attempt
      </button>

      <div id="submitMessage" class="alert hidden"></div>
    </div>
  </div>

  <!-- ══════════════════════════════════════════
       SECTION 6 — Result
  ══════════════════════════════════════════ -->
  <div id="sectionResult" class="card hidden">
    <h2 id="resultHeader" style="text-align:center; font-family:'Playfair Display',serif; color:var(--accent);">Test Completed</h2>
    <p id="resultScore" style="font-size:1.8rem; text-align:center; margin:1.5rem 0;"></p>
    <p id="resultRank" class="rank-display"></p>
    <div id="reviewContainer" class="hidden"></div>
    <button id="btnResultBack" class="btn btn-paid"
            style="display:block; margin:2rem auto; width:220px;">
      Back to Home
    </button>
  </div>

  <!-- ══════════════════════════════════════════
       SECTION 7 — Leaderboard (inline)
  ══════════════════════════════════════════ -->
  <div id="sectionLeaderboard" class="card hidden">
    <h2 style="text-align:center; font-family:'Playfair Display',serif;">
      Leaderboard
      <small style="font-family:'JetBrains Mono',monospace; font-size:0.75rem; color:var(--text-secondary);">
        (ranked / on-time attempts only for paid)
      </small>
    </h2>
    <div id="leaderboard" style="margin-top:1.5rem;"></div>
  </div>

</div><!-- /container -->


<script type="module">
  const {
    initializeApp, getAnalytics, getAuth, signInWithPopup,
    GoogleAuthProvider, onAuthStateChanged, signOut
  } = window.firebaseModules;

  const firebaseConfig = {
    apiKey: "AIzaSyALLdLzpaEE6B0rp4R_M1XTLBq6zHfZcf0",
    authDomain: "cronbpsc.firebaseapp.com",
    projectId: "cronbpsc",
    storageBucket: "cronbpsc.firebasestorage.app",
    messagingSenderId: "66923138072",
    appId: "1:66923138072:web:ea79ce45bc8c7c15c2476d",
    measurementId: "G-Y37J7BL805"
  };
  const app = initializeApp(firebaseConfig);
  getAnalytics(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const API_URL = "https://cronuserbackend.vercel.app";

  let currentUser = null;
  let currentTestId = null;
  let isFreeMode = false;
  let userAnswers = {};
  let isLateAttempt = false;

  const SECTIONS = [
    "sectionHome", "sectionFreeList", "sectionPaidLogin",
    "sectionPaidList", "sectionTest", "sectionResult", "sectionLeaderboard"
  ];

  function showOnly(...ids) {
    SECTIONS.forEach(id => document.getElementById(id)?.classList.add("hidden"));
    ids.forEach(id => document.getElementById(id)?.classList.remove("hidden"));
  }

  function resetTestState() {
    currentTestId = null;
    userAnswers = {};
    isLateAttempt = false;
    document.getElementById("questionsContainer").innerHTML = "";
    document.getElementById("statusMessage")?.classList.add("hidden");
    document.getElementById("lateWarning")?.classList.add("hidden");
    document.getElementById("btnSubmitTest")?.classList.add("hidden");
    document.getElementById("btnReviewTest")?.classList.add("hidden");
    document.getElementById("submitMessage")?.classList.add("hidden");
    document.getElementById("persistentNote")?.classList.add("hidden");
    document.getElementById("reviewContainer")?.classList.add("hidden");
    document.getElementById("leaderboard").innerHTML = "";
  }

  // ─── Get current date in YYYY-MM-DD (IST) ───
  function getTodayIST() {
    const now = new Date();
    const IST_OFFSET_MS = 5.5 * 60 * 60 * 1000;
    const nowIST = new Date(now.getTime() + IST_OFFSET_MS);
    return nowIST.toISOString().split("T")[0];
  }

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
      document.getElementById("userDisplay").textContent = user.displayName || user.email.split("@")[0];
      document.getElementById("btnLogout").classList.remove("hidden");
      if (!document.getElementById("sectionPaidLogin").classList.contains("hidden")) {
        showPaidTestsList();
      }
    } else {
      currentUser = null;
      document.getElementById("userDisplay").textContent = "Guest";
      document.getElementById("btnLogout").classList.add("hidden");
    }
  });

  // ─── Home buttons ───
  document.getElementById("btnBrowseFree").addEventListener("click", () => {
    isFreeMode = true;
    showOnly("sectionFreeList");
    loadFreeTestsList();
  });

  document.getElementById("btnBrowsePaid").addEventListener("click", () => {
    isFreeMode = false;
    if (currentUser) {
      showOnly("sectionPaidList");
      loadPaidTestsList();
    } else {
      showOnly("sectionPaidLogin");
    }
  });

  // Back buttons
  document.getElementById("btnBackFromFreeList")?.addEventListener("click", () => showOnly("sectionHome"));
  document.getElementById("btnBackFromLogin")?.addEventListener("click", () => showOnly("sectionHome"));
  document.getElementById("btnBackFromPaidList")?.addEventListener("click", () => showOnly("sectionHome"));
  document.getElementById("btnBackFromTest")?.addEventListener("click", () => {
    resetTestState();
    showOnly(isFreeMode ? "sectionFreeList" : "sectionPaidList");
  });
  document.getElementById("btnResultBack")?.addEventListener("click", () => {
    resetTestState();
    showOnly("sectionHome");
  });

  // Google Login
  document.getElementById("btnGoogleLogin")?.addEventListener("click", async () => {
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      document.getElementById("authMessage").innerHTML = `<span style="color:var(--danger);">Login failed: ${err.message}</span>`;
    }
  });

  document.getElementById("btnLogout")?.addEventListener("click", async () => {
    await signOut(auth);
    resetTestState();
    showOnly("sectionHome");
  });

  // ─── Load Free Tests List ─── (filter by date)
  async function loadFreeTestsList() {
    const grid = document.getElementById("freeTestsGrid");
    grid.innerHTML = `<div class="loader">Loading free tests...</div>`;

    try {
      const res = await fetch(`${API_URL}/free/tests`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      grid.innerHTML = "";

      if (!data.success || !data.tests?.length) {
        grid.innerHTML = `<p>No free tests available.</p>`;
        return;
      }

      const today = getTodayIST();

      const visibleTests = data.tests.filter(test => {
        // If no date or "—" → always show (persistent)
        if (!test.date || test.date === "—") return true;
        // Show only if test date ≤ today
        return test.date <= today;
      });

      if (visibleTests.length === 0) {
        grid.innerHTML = `<p>No free tests available yet for today (${today}).</p>`;
        return;
      }

      visibleTests.forEach(test => {
        const card = document.createElement("div");
        card.className = "test-card";
        card.innerHTML = `
          <h3>${test.title || "Free Practice Test"}</h3>
          <div class="test-card-meta">
            <span><strong>Date:</strong> ${test.date || "Anytime"}</span>
            <span><strong>Questions:</strong> ${test.totalQuestions}</span>
          </div>
          <button class="btn btn-free start-free-btn" data-test-id="${test.testId}">
            Start Test
          </button>
        `;
        grid.appendChild(card);
      });
    } catch (err) {
      grid.innerHTML = `<p style="color:var(--danger);">Error loading free tests: ${err.message}</p>`;
    }
  }

  document.getElementById("freeTestsGrid")?.addEventListener("click", e => {
    const btn = e.target.closest(".start-free-btn");
    if (btn) startFreeTest(btn.dataset.testId);
  });

  // ─── Start Free Test ───
  async function startFreeTest(testId) {
    resetTestState();
    isFreeMode = true;
    showOnly("sectionTest");
    document.getElementById("testTitle").textContent = "Loading…";

    try {
      const res = await fetch(`${API_URL}/free/test/${testId}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      currentTestId = data.testId;
      document.getElementById("testTitle").textContent = data.title || "Free Practice Test";
      document.getElementById("testInfo").textContent = `Total Questions: ${data.totalQuestions}`;

      if (data.note) {
        document.getElementById("persistentNote").textContent = data.note;
        document.getElementById("persistentNote").classList.remove("hidden");
      }

      renderQuestions(data.questions);
      document.getElementById("btnSubmitTest").classList.remove("hidden");
    } catch (err) {
      document.getElementById("testInfo").textContent = `Failed to load test: ${err.message}`;
    }
  }

  // ─── Load Paid Tests List ─── (now date-aware)
  async function loadPaidTestsList() {
    const grid = document.getElementById("paidTestsGrid");
    grid.innerHTML = `<div class="loader">Loading paid tests...</div>`;

    try {
      const token = await currentUser.getIdToken();
      const res = await fetch(`${API_URL}/user/today-test`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      grid.innerHTML = "";

      if (res.status === 401) {
        grid.innerHTML = `<p>Please log in to view paid tests.</p>`;
        return;
      }

      if (res.status === 404) {
        grid.innerHTML = `<p>No paid test available today.</p>`;
        return;
      }

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      if (data.status === "not_started") {
        grid.innerHTML = `<p>Today's test not started yet (${data.message || ""})</p>`;
        return;
      }

      if (data.status === "archived") {
        grid.innerHTML = `<p>Test has ended. Review available.</p>`;
        const card = document.createElement("div");
        card.className = "test-card";
        card.innerHTML = `
          <h3>${data.title || "Archived Paid Test"}</h3>
          <div class="test-card-meta">
            <span><strong>Date:</strong> ${getTodayIST()}</span>
          </div>
          <button class="btn btn-paid start-paid-btn" data-test-id="${data.testId}">
            Review Test
          </button>
        `;
        grid.appendChild(card);
        return;
      }

      // Active test
      const card = document.createElement("div");
      card.className = "test-card";
      card.innerHTML = `
        <h3>${data.title || "Today's Paid Test"}</h3>
        <div class="test-card-meta">
          <span><strong>Date:</strong> ${getTodayIST()}</span>
          <span><strong>Questions:</strong> ${data.totalQuestions}</span>
        </div>
        <button class="btn btn-paid start-paid-btn" data-test-id="${data.testId}">
          Start Test
        </button>
      `;
      grid.appendChild(card);
    } catch (err) {
      grid.innerHTML = `<p style="color:var(--danger);">Error: ${err.message}</p>`;
    }
  }

  document.getElementById("paidTestsGrid")?.addEventListener("click", e => {
    const btn = e.target.closest(".start-paid-btn");
    if (btn) startPaidTest(btn.dataset.testId);
  });

  // ─── Start Paid Test ───
  async function startPaidTest(testId) {
    resetTestState();
    isFreeMode = false;
    showOnly("sectionTest");
    document.getElementById("testTitle").textContent = "Loading…";

    try {
      const token = await currentUser.getIdToken();
      const res = await fetch(`${API_URL}/user/today-test`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      currentTestId = data.testId;
      document.getElementById("testTitle").textContent = data.title || "Paid Test";
      document.getElementById("testInfo").textContent = `Total Questions: ${data.totalQuestions}`;

      if (data.status === "not_started") {
        document.getElementById("statusMessage").textContent = data.message;
        document.getElementById("statusMessage").classList.remove("hidden");
        return;
      }

      if (data.status === "archived") {
        document.getElementById("statusMessage").textContent = data.message;
        document.getElementById("statusMessage").classList.remove("hidden");
        document.getElementById("btnReviewTest").classList.remove("hidden");
        return;
      }

      renderQuestions(data.questions || []);
      document.getElementById("btnSubmitTest").classList.remove("hidden");
    } catch (err) {
      document.getElementById("testInfo").textContent = `Error: ${err.message}`;
    }
  }

  // ─── Render Questions ───
  function renderQuestions(questions) {
    const container = document.getElementById("questionsContainer");
    container.innerHTML = "";
    questions.forEach(q => {
      const div = document.createElement("div");
      div.className = "question";
      div.innerHTML = `
        <h3>Q${q.questionNumber || "?"}. ${q.questionStatement || ""}</h3>
        <label class="option"><input type="radio" name="q_${q._id}" value="option1"> ${q.options?.option1 || "—"}</label>
        <label class="option"><input type="radio" name="q_${q._id}" value="option2"> ${q.options?.option2 || "—"}</label>
        <label class="option"><input type="radio" name="q_${q._id}" value="option3"> ${q.options?.option3 || "—"}</label>
        <label class="option"><input type="radio" name="q_${q._id}" value="option4"> ${q.options?.option4 || "—"}</label>
      `;
      container.appendChild(div);
    });
  }

  /* ─────────────────────────────────────────────────
     SUBMIT
  ───────────────────────────────────────────────── */
  document.getElementById("btnSubmitTest").addEventListener("click", submitTest);

  async function submitTest() {
    const total    = document.querySelectorAll(".question").length;
    const answered = Object.keys(userAnswers).length;

    if (answered < total) {
      alert(`Please answer all ${total} questions. (${answered} answered so far)`);
      return;
    }
    if (!confirm("Are you sure you want to submit?")) return;

    const answersArray = Object.entries(userAnswers).map(([qid, opt]) => ({
      questionId: qid, selectedOption: opt
    }));

    const submitMsg = document.getElementById("submitMessage");
    submitMsg.textContent = "Submitting…";
    submitMsg.className   = "alert alert-info";

    try {
      const endpoint = isFreeMode
        ? `/free/submit-test/${currentTestId}`
        : `/user/submit-test/${currentTestId}`;

      const headers = { "Content-Type": "application/json" };
      if (!isFreeMode) headers["Authorization"] = `Bearer ${await currentUser.getIdToken()}`;

      const res  = await fetch(`${API_URL}${endpoint}`, {
        method:  "POST",
        headers,
        body:    JSON.stringify({ answers: answersArray })
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.message || `HTTP ${res.status}`);
      }

      const data = await res.json();

      if (!isFreeMode && data.isLate) {
        isLateAttempt = true;
        document.getElementById("lateWarning").classList.remove("hidden");
      }

      /* Show result section */
      document.getElementById("resultHeader").textContent = "Test Completed";
      document.getElementById("resultScore").textContent  = `Score: ${data.score} / ${data.totalQuestions}`;
      document.getElementById("resultRank").textContent   = isFreeMode
        ? (data.rankDisplay || `Rank: ${data.yourRank}`)
        : (data.isRanked ? `Rank: ${data.preliminaryRank}` : "Practice attempt — no rank");

      document.getElementById("reviewContainer").classList.add("hidden");
      document.getElementById("btnReviewTest").classList.remove("hidden");
      showOnly("sectionResult", "sectionLeaderboard");
      await loadLeaderboard();

    } catch (err) {
      submitMsg.textContent = err.message || "Submission failed.";
      submitMsg.className   = "alert alert-error";
    }
  }

  /* ─────────────────────────────────────────────────
     REVIEW (paid only)
  ───────────────────────────────────────────────── */
  document.getElementById("btnReviewTest").addEventListener("click", loadReview);

  async function loadReview() {
    if (!currentTestId || isFreeMode) return;

    const container = document.getElementById("reviewContainer");
    container.innerHTML = "<p>Loading review…</p>";
    container.classList.remove("hidden");

    /* Make result section visible if we came from the archived-test view */
    if (document.getElementById("sectionResult").classList.contains("hidden")) {
      showOnly("sectionResult", "sectionLeaderboard");
    }

    try {
      const token = await currentUser.getIdToken();
      const res   = await fetch(`${API_URL}/user/review-test/${currentTestId}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();

      document.getElementById("resultHeader").textContent =
        data.isLate ? "Practice Attempt Review" : "Your Performance Review";
      document.getElementById("resultScore").textContent =
        `Score: ${data.score} / ${data.totalQuestions}`;
      document.getElementById("resultRank").textContent = data.rankInfo
        ? `Rank: ${data.rankInfo.rank} / ${data.rankInfo.totalParticipants}`
        : "No rank (late attempt)";

      container.innerHTML = "";
      data.questions.forEach(q => {
        const div = document.createElement("div");
        div.className = "question";
        div.innerHTML = `
          <h3>Q${q.questionNumber}. ${escHtml(q.questionStatement)}</h3>
          <p><strong>Your answer:</strong>
            <span class="${q.isCorrect ? 'correct' : 'wrong'}">${escHtml(q.yourAnswer || "—")}</span>
          </p>
          <p><strong>Correct answer:</strong>
            <span class="correct">${escHtml(q.correctAnswer)}</span>
          </p>
          <p style="margin-top:0.8rem;">${q.isCorrect ? "✓ Correct" : "✗ Incorrect"}</p>
        `;
        container.appendChild(div);
      });

    } catch (err) {
      container.innerHTML = `<p style="color:var(--danger);">Could not load review: ${err.message}</p>`;
    }
  }

  /* ─────────────────────────────────────────────────
     LEADERBOARD
  ───────────────────────────────────────────────── */
  async function loadLeaderboard() {
    if (!currentTestId) return;

    const lbEl = document.getElementById("leaderboard");
    lbEl.innerHTML = `<div class="loader">Loading leaderboard</div>`;
    document.getElementById("sectionLeaderboard").classList.remove("hidden");

    try {
      const endpoint = isFreeMode
        ? `/free/leaderboard/${currentTestId}`
        : `/user/leaderboard/${currentTestId}`;

      const headers = {};
      if (!isFreeMode && currentUser) {
        headers["Authorization"] = `Bearer ${await currentUser.getIdToken()}`;
      }

      const res  = await fetch(`${API_URL}${endpoint}`, { headers });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const { leaderboard, totalParticipants, totalRankedParticipants } = await res.json();

      lbEl.innerHTML = "";

      if (!leaderboard?.length) {
        lbEl.innerHTML = "<p style='color:var(--text-secondary);'>No results yet. Be the first!</p>";
        return;
      }

      const table = document.createElement("table");
      table.innerHTML = `<tr><th>Rank</th><th>Score</th><th>Submitted</th></tr>`;
      leaderboard.forEach((item, idx) => {
        const time = new Date(item.submittedAt).toLocaleTimeString("en-IN", {
          hour: "2-digit", minute: "2-digit"
        });
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.rank ?? idx + 1}</td>
          <td>${item.score} / ${item.totalQuestions ?? "?"}</td>
          <td>${time}</td>
        `;
        table.appendChild(row);
      });
      lbEl.appendChild(table);

      const total = totalParticipants ?? totalRankedParticipants ?? "?";
      const note  = document.createElement("p");
      note.style.cssText = "text-align:center; margin-top:1rem; color:var(--text-secondary); font-size:0.9rem;";
      note.textContent = `Total participants: ${total}`;
      lbEl.appendChild(note);

    } catch (err) {
      lbEl.innerHTML = `<p style="color:var(--danger);">Leaderboard unavailable: ${err.message}</p>`;
    }
  }

  /* Periodic refresh */
  setInterval(() => {
    if (currentTestId) loadLeaderboard();
  }, 90_000);

  /* ─────────────────────────────────────────────────
     UTILITY
  ───────────────────────────────────────────────── */
  function escHtml(str) {
    return String(str ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  /* ─────────────────────────────────────────────────
     INITIAL STATE — show home
  ───────────────────────────────────────────────── */
  showOnly("sectionHome");
</script>
</body>
</html>
